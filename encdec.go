package base64

import (
	"errors"
)

const cs = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"

func Encode(dst, src []byte) {
	l := len(src) - 5
	i, j := 0, 0
	for i < l {
		ui8 := uint64(src[i])<<40 | uint64(src[i+1])<<32 | uint64(src[i+2])<<24 | uint64(src[i+3])<<16 | uint64(src[i+4])<<8 | uint64(src[i+5])
		dst[j] = cs[(ui8>>42)&0b111111]
		dst[j+1] = cs[(ui8>>36)&0b111111]
		dst[j+2] = cs[(ui8>>30)&0b111111]
		dst[j+3] = cs[(ui8>>24)&0b111111]
		dst[j+4] = cs[(ui8>>18)&0b111111]
		dst[j+5] = cs[(ui8>>12)&0b111111]
		dst[j+6] = cs[(ui8>>6)&0b111111]
		dst[j+7] = cs[ui8&0b111111]
		i += 6
		j += 8
	}
	switch i - l {
	case 0:
		ui8 := uint64(src[i])<<40 | uint64(src[i+1])<<32 | uint64(src[i+2])<<24 | uint64(src[i+3])<<16 | uint64(src[i+4])<<8
		dst[j] = cs[(ui8>>42)&0b111111]
		dst[j+1] = cs[(ui8>>36)&0b111111]
		dst[j+2] = cs[(ui8>>30)&0b111111]
		dst[j+3] = cs[(ui8>>24)&0b111111]
		dst[j+4] = cs[(ui8>>18)&0b111111]
		dst[j+5] = cs[(ui8>>12)&0b111111]
		dst[j+6] = cs[(ui8>>6)&0b111111]
		dst[j+7] = '='
	case 1:
		ui8 := uint64(src[i])<<40 | uint64(src[i+1])<<32 | uint64(src[i+2])<<24 | uint64(src[i+3])<<16
		dst[j] = cs[(ui8>>42)&0b111111]
		dst[j+1] = cs[(ui8>>36)&0b111111]
		dst[j+2] = cs[(ui8>>30)&0b111111]
		dst[j+3] = cs[(ui8>>24)&0b111111]
		dst[j+4] = cs[(ui8>>18)&0b111111]
		dst[j+5] = cs[(ui8>>12)&0b111111]
		dst[j+6] = '='
		dst[j+7] = '='
	case 2:
		ui8 := uint64(src[i])<<40 | uint64(src[i+1])<<32 | uint64(src[i+2])<<24
		dst[j] = cs[(ui8>>42)&0b111111]
		dst[j+1] = cs[(ui8>>36)&0b111111]
		dst[j+2] = cs[(ui8>>30)&0b111111]
		dst[j+3] = cs[(ui8>>24)&0b111111]
	case 3:
		ui8 := uint64(src[i])<<40 | uint64(src[i+1])<<32
		dst[j] = cs[(ui8>>42)&0b111111]
		dst[j+1] = cs[(ui8>>36)&0b111111]
		dst[j+2] = cs[(ui8>>30)&0b111111]
		dst[j+3] = '='
	case 4:
		ui8 := uint64(src[i]) << 40
		dst[j] = cs[(ui8>>42)&0b111111]
		dst[j+1] = cs[(ui8>>36)&0b111111]
		dst[j+2] = '='
		dst[j+3] = '='
	}
}

var z = [256]uint64{
	127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
	127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
	127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 62, 127, 127, 127, 63,
	52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 127, 127, 127, 0, 127, 127,
	127, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14,
	15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 127, 127, 127, 127, 127,
	127, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
	41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 127, 127, 127, 127, 127,
	127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
	127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
	127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
	127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
	127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
	127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
	127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
	127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127,
}

func Decode(dst, src []byte) (j int, err error) {
	/*
		z := [256]uint64{
			'A': 0, 'B': 1, 'C': 2, 'D': 3, 'E': 4, 'F': 5, 'G': 6, 'H': 7,
			'I': 8, 'J': 9, 'K': 10, 'L': 11, 'M': 12, 'N': 13, 'O': 14, 'P': 15,
			'Q': 16, 'R': 17, 'S': 18, 'T': 19, 'U': 20, 'V': 21, 'W': 22, 'X': 23,
			'Y': 24, 'Z': 25, 'a': 26, 'b': 27, 'c': 28, 'd': 29, 'e': 30, 'f': 31,
			'g': 32, 'h': 33, 'i': 34, 'j': 35, 'k': 36, 'l': 37, 'm': 38, 'n': 39,
			'o': 40, 'p': 41, 'q': 42, 'r': 43, 's': 44, 't': 45, 'u': 46, 'v': 47,
			'w': 48, 'x': 49, 'y': 50, 'z': 51, '0': 52, '1': 53, '2': 54, '3': 55,
			'4': 56, '5': 57, '6': 58, '7': 59, '8': 60, '9': 61, '+': 62, '/': 63,
		}
		for i := range 256 {
			if z[i] == 0 {
				z[i] = 127
			}
		}
		z['='] = 0
		z['A'] = 0
		z, _ := json.Marshal(z)
		println(string(z))
	*/
	i := 0
	l := len(dst) - 6
	for j < l {
		x0, x1, x2, x3, x4, x5, x6, x7 := z[src[i]], z[src[i+1]], z[src[i+2]], z[src[i+3]], z[src[i+4]], z[src[i+5]], z[src[i+6]], z[src[i+7]]
		if x0|x1|x2|x3|x4|x5|x6|x7 == 127 {
			err = errors.New("invalid base-64")
			return
		}
		i += 8
		v := ((((((x0<<6|x1)<<6|x2)<<6|x3)<<6|x4)<<6|x5)<<6|x6)<<6 | x7
		dst[j] = byte(v >> 40)
		dst[j+1] = byte(v >> 32)
		dst[j+2] = byte(v >> 24)
		dst[j+3] = byte(v >> 16)
		dst[j+4] = byte(v >> 8)
		dst[j+5] = byte(v)
		j += 6
	}
	x0, x1, x2, x3 := z[src[i]], z[src[i+1]], z[src[i+2]], z[src[i+3]]
	if x0|x1|x2|x3 == 127 {
		err = errors.New("invalid base-64")
		return
	}
	v := ((x0<<6|x1)<<6|x2)<<6 | x3
	dst[j] = byte(v >> 16)
	switch j - l {
	case 3:
		dst[j+1] = byte(v >> 8)
		dst[j+2] = byte(v)
		return j + 3, nil
	case 4:
		dst[j+1] = byte(v >> 8)
		return j + 2, nil
	case 5:
		return j + 1, nil
	}
	x4, x5, x6, x7 := z[src[i+4]], z[src[i+5]], z[src[i+6]], z[src[i+7]]
	if x4|x5|x6|x7 == 127 {
		err = errors.New("invalid base-64")
		return
	}
	dst[j+1] = byte(v >> 8)
	dst[j+2] = byte(v)
	v = ((x4<<6|x5)<<6|x6)<<6 | x7
	dst[j+3] = byte(v >> 16)
	switch j - l {
	case 0:
		dst[j+4] = byte(v >> 8)
		dst[j+5] = byte(v)
		return j + 6, nil
	case 1:
		dst[j+4] = byte(v >> 8)
		return j + 5, nil
	case 2:
		return j + 4, nil
	}
	return
}

//012345678911234567892123456789312345
//012 345 678 911 234 567 892 123 456
